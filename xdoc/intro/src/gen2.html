<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">mockfs</span> <span class="kn">import</span> <span class="n">MockFS</span>
<span class="kn">from</span> <span class="nn">xbuild</span> <span class="kn">import</span> <span class="n">Task</span><span class="p">,</span> <span class="n">Builder</span><span class="p">,</span> <span class="n">targetUpToDate</span>
<span class="kn">import</span> <span class="nn">xbuild.fs</span> <span class="kn">as</span> <span class="nn">xfs</span>


<span class="k">class</span> <span class="nc">EndFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fpath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>


<span class="c1"># It&#39;s an action function.</span>
<span class="k">def</span> <span class="nf">concatAction</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Read and append all file dependencies.</span>
    <span class="c1"># Task.getFileDeps() returns all file dependencies and</span>
    <span class="c1"># all generated and provided files from the task dependencies.</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">getFileDeps</span><span class="p">(</span><span class="n">bldr</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="c1"># Write targets.</span>
    <span class="k">for</span> <span class="n">trg</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trg</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="c1"># Action function for the generator.</span>
<span class="k">def</span> <span class="nf">mainGeneratorAction</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">cfgPath</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cfgValue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfgPath</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfgValue</span><span class="p">):</span>
        <span class="c1"># generate .txt file</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;gen/gen{}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;Generated file {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">generatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="c1"># generate .json file</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;gen/gen{}.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">jsonStr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;list entry: &#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="s1">&#39;*&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)]},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">jsonStr</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">generatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>    <span class="c1"># success</span>


<span class="c1"># Action for the size and lines generator.</span>
<span class="k">def</span> <span class="nf">subGeneratorAction</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">srcExt</span><span class="p">,</span> <span class="n">dstExt</span><span class="p">):</span>
    <span class="n">genFiles</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">getFileDeps</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">EndFilter</span><span class="p">(</span><span class="n">srcExt</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">providedFiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;out/&#39;</span> <span class="o">+</span> <span class="n">xfs</span><span class="o">.</span><span class="n">splitExt</span><span class="p">(</span><span class="n">xfs</span><span class="o">.</span><span class="n">baseName</span><span class="p">(</span><span class="n">g</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dstExt</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genFiles</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="c1"># Action function for size and lines file building</span>
<span class="k">def</span> <span class="nf">countAction</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">countFn</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">countFn</span><span class="p">(</span><span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;{} {} = {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">trg</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trg</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">countTaskFactory</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">srcExt</span><span class="p">,</span> <span class="n">countFn</span><span class="p">):</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trg</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">providedFiles</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">getFileDeps</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">EndFilter</span><span class="p">(</span><span class="n">srcExt</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">)):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Task</span><span class="p">(</span>
                 <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">trg</span><span class="p">],</span>
                 <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="n">src</span><span class="p">],</span>
                 <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
                 <span class="n">action</span><span class="o">=</span><span class="p">(</span><span class="n">countAction</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;countFn&#39;</span><span class="p">:</span> <span class="n">countFn</span><span class="p">})))</span>
    <span class="k">return</span> <span class="n">tasks</span>


<span class="k">def</span> <span class="nf">countLines</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>


<span class="c1"># This example runs on a virtual (mock) filesystem.</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">MockFS</span><span class="p">()</span>
<span class="c1"># Creating a generator configuration file.</span>
<span class="c1"># Here content 2 means the number of files, the generator creates.</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cfg/cfg.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># Create a Builder.</span>
<span class="n">bldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="c1"># Create the generator task.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;generator&#39;</span><span class="p">,</span>
    <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cfg/cfg.txt&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>    <span class="c1"># It is a common up-to-date function which is good for most purposes.</span>
    <span class="n">action</span><span class="o">=</span><span class="n">mainGeneratorAction</span><span class="p">)</span>
<span class="c1"># Create generator for creating .size files from .txt files</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sizeGenerator&#39;</span><span class="p">,</span>
    <span class="n">taskDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="p">(</span><span class="n">subGeneratorAction</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;srcExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dstExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.size&#39;</span><span class="p">}),</span>
    <span class="n">taskFactory</span><span class="o">=</span><span class="p">(</span><span class="n">countTaskFactory</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;size of&#39;</span><span class="p">,</span> <span class="s1">&#39;srcExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;countFn&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">}))</span>
<span class="c1"># Create generator for creating .lines files from .json files</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;linesGenerator&#39;</span><span class="p">,</span>
    <span class="n">taskDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="p">(</span><span class="n">subGeneratorAction</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;srcExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;dstExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.lines&#39;</span><span class="p">}),</span>
    <span class="n">taskFactory</span><span class="o">=</span><span class="p">(</span><span class="n">countTaskFactory</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;lines in&#39;</span><span class="p">,</span> <span class="s1">&#39;srcExt&#39;</span><span class="p">:</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;countFn&#39;</span><span class="p">:</span> <span class="n">countLines</span><span class="p">}))</span>
<span class="c1"># Create a task for concatenating the .size files</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out/txtInfo.txt&#39;</span><span class="p">],</span>
    <span class="n">taskDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sizeGenerator&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="n">concatAction</span><span class="p">)</span>
<span class="c1"># Create a task for concatenating the .lines files</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out/jsonInfo.txt&#39;</span><span class="p">],</span>
    <span class="n">taskDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;linesGenerator&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="n">concatAction</span><span class="p">)</span>
<span class="c1"># Create a main task.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
    <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out/txtInfo.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;out/jsonInfo.txt&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">)</span>
<span class="c1"># Build the main task.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">buildOne</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="c1"># Print the target.</span>
<span class="k">print</span> <span class="s2">&quot;Content of out/txtInfo.txt:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;out/txtInfo.txt&#39;</span><span class="p">))</span>
<span class="k">print</span> <span class="s2">&quot;Content of out/jsonInfo.txt:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;out/jsonInfo.txt&#39;</span><span class="p">))</span>
<span class="c1"># Print the PlantUML representation of the after-build dependency graph.</span>
<span class="k">print</span> <span class="n">bldr</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">genPlantUML</span><span class="p">()</span>
</pre></div>
