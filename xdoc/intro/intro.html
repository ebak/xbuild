<html>
<style>
.hll { background-color: #ffffcc }
.c { color: #408080; font-style: italic } /* Comment */
.err { border: 1px solid #FF0000 } /* Error */
.k { color: #008000; font-weight: bold } /* Keyword */
.o { color: #666666 } /* Operator */
.ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cp { color: #BC7A00 } /* Comment.Preproc */
.cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.c1 { color: #408080; font-style: italic } /* Comment.Single */
.cs { color: #408080; font-style: italic } /* Comment.Special */
.gd { color: #A00000 } /* Generic.Deleted */
.ge { font-style: italic } /* Generic.Emph */
.gr { color: #FF0000 } /* Generic.Error */
.gh { color: #000080; font-weight: bold } /* Generic.Heading */
.gi { color: #00A000 } /* Generic.Inserted */
.go { color: #888888 } /* Generic.Output */
.gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.gs { font-weight: bold } /* Generic.Strong */
.gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.gt { color: #0044DD } /* Generic.Traceback */
.kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.kp { color: #008000 } /* Keyword.Pseudo */
.kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.kt { color: #B00040 } /* Keyword.Type */
.m { color: #666666 } /* Literal.Number */
.s { color: #BA2121 } /* Literal.String */
.na { color: #7D9029 } /* Name.Attribute */
.nb { color: #008000 } /* Name.Builtin */
.nc { color: #0000FF; font-weight: bold } /* Name.Class */
.no { color: #880000 } /* Name.Constant */
.nd { color: #AA22FF } /* Name.Decorator */
.ni { color: #999999; font-weight: bold } /* Name.Entity */
.ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.nf { color: #0000FF } /* Name.Function */
.nl { color: #A0A000 } /* Name.Label */
.nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.nt { color: #008000; font-weight: bold } /* Name.Tag */
.nv { color: #19177C } /* Name.Variable */
.ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.w { color: #bbbbbb } /* Text.Whitespace */
.mb { color: #666666 } /* Literal.Number.Bin */
.mf { color: #666666 } /* Literal.Number.Float */
.mh { color: #666666 } /* Literal.Number.Hex */
.mi { color: #666666 } /* Literal.Number.Integer */
.mo { color: #666666 } /* Literal.Number.Oct */
.sb { color: #BA2121 } /* Literal.String.Backtick */
.sc { color: #BA2121 } /* Literal.String.Char */
.sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.s2 { color: #BA2121 } /* Literal.String.Double */
.se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.sh { color: #BA2121 } /* Literal.String.Heredoc */
.si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.sx { color: #008000 } /* Literal.String.Other */
.sr { color: #BB6688 } /* Literal.String.Regex */
.s1 { color: #BA2121 } /* Literal.String.Single */
.ss { color: #19177C } /* Literal.String.Symbol */
.bp { color: #008000 } /* Name.Builtin.Pseudo */
.vc { color: #19177C } /* Name.Variable.Class */
.vg { color: #19177C } /* Name.Variable.Global */
.vi { color: #19177C } /* Name.Variable.Instance */
.il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
<body>
<h1>xbuild introduction</h1>
<i>xbuild</i> is inspired by <a href="http://pydoit.org">pydoit</a>. Unfortunately pydoit is not really able to handle
<a href="https://github.com/pydoit/doit/issues/127">code generators</a>. <i>xbuild</i>'s main aim is to keep the simplicity of
<i>pydoit</i> and to provide a solution for the code generators.

<p><i>xbuild</i> provides a minimalistic API. Contrary to <i>scons</i> or <i>make</i> it doesn't provide any high level patterns
and gypsy-magics like pattern rules or environments.
<i>xbuild</i> is python based. Python is a feature rich and popular scripting language, which allows you to programatically build up the
dependency graph in many different ways. It has also thousands of useful, easy to use modules which can help a lot. With <i>xbuild</i>
you can use your own patterns for your build system.</p>

<p>In <i>xbuild</i> the main dependency graph entity is the <b>Task</b>. A <i>task</i> may have <i>targets</i> and <i>dependencies</i>.
<i>Targets</i> are always files. The <i>dependencies</i> can be files or other <i>Tasks</i>.The <i>Task</i> constructor has two basic
arguments which accepts functions, these are the <i>upToDate</i> and <i>action</i> arguments. <ul><li><i>upToDate</i> is executed when the
<i>Task</i> is requested and all of its dependencies are up-to-date. It must return <i>True</i> when the task is up-to-date, or
<i>False</i> when it is not up-to-date. In case of error it must return with an <i>int</i> or throw an <i>Exception</i></li>
<li><i>action</i> is executed when the <i>Task</i> is requested and it is up-to-date (dependencies are up-to-date and the
<i>upToDate</i> function returned <i>True</i>). It must do the "real stuff", like compilation, linking, etc. It must return <i>0</i>
on success or a non-zero <i>int</i> in case of error.</li></ul></p>

<p>The main API class is the <b>Builder</b>. Here are its most important functions:
</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">addTask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[],</span> <span class="n">fileDeps</span><span class="o">=</span><span class="p">[],</span> <span class="n">taskDeps</span><span class="o">=</span><span class="p">[],</span> <span class="n">taskFactory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">upToDate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">summary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a Task to the dependency graph.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">buildOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Builds a target. &quot;target&quot; can also be a task name.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Builds a list targets. A &quot;target&quot; can also be a task name.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetOrNameList</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans a list of targets. (The list entries can be targets and task names).&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">cleanOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetOrName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans a target or a task referred by its name.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">listTasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Lists tasks which have summary.&#39;&#39;&#39;</span>
</pre></div>

<h2>Simple example for concatenating files.</h2>

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mockfs</span> <span class="kn">import</span> <span class="n">MockFS</span>
<span class="kn">from</span> <span class="nn">xbuild</span> <span class="kn">import</span> <span class="n">Builder</span><span class="p">,</span> <span class="n">targetUpToDate</span>


<span class="c1"># It&#39;s an action function.</span>
<span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Read and append all file dependencies.</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">getAllFileDeps</span><span class="p">(</span><span class="n">bldr</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="c1"># Write targets.</span>
    <span class="k">for</span> <span class="n">trg</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trg</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="c1"># This example runs on a virtual (mock) filesystem.</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">MockFS</span><span class="p">()</span>
<span class="c1"># Let&#39;s create some files for input.</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;src/a.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;aFile</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;src/b.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;bFile</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># Create a Builder.</span>
<span class="n">bldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="c1"># Create a task for concatenating the two files.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out/concat.txt&#39;</span><span class="p">],</span>
    <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src/a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;src/b.txt&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>    <span class="c1"># It is a common up-to-date function which is good for most purposes.</span>
    <span class="n">action</span><span class="o">=</span><span class="n">concat</span><span class="p">)</span>
<span class="c1"># Build the target.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">buildOne</span><span class="p">(</span><span class="s1">&#39;out/concat.txt&#39;</span><span class="p">)</span>
<span class="c1"># Print the target.</span>
<span class="k">print</span> <span class="s2">&quot;Content of target:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;out/concat.txt&#39;</span><span class="p">))</span>
</pre></div>
<p>Note that the file system is accessed via the <i>fs</i> object. It makes possible easy mocking and mapping non file system resources
as file system resources in <i>python</i> level.</p>
<p>Here is the visual representation of the example task.</p>
<img src="basic0.png"/>

<h2>Code generator tasks</h2>

<h3>Simple case</h3>
<p>The generated code is used directly by the parent task.</p>

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mockfs</span> <span class="kn">import</span> <span class="n">MockFS</span>
<span class="kn">from</span> <span class="nn">xbuild</span> <span class="kn">import</span> <span class="n">Builder</span><span class="p">,</span> <span class="n">targetUpToDate</span>


<span class="c1"># It&#39;s an action function.</span>
<span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">filterTxt</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="c1"># Returns True when the file extension is &quot;txt.&quot;</span>
        <span class="k">return</span> <span class="n">fpath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Read and append all file dependencies.</span>
    <span class="c1"># Task.getFileDeps() returns all matching file dependencies and</span>
    <span class="c1"># all matching generated and provided files from the task dependencies.</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">getFileDeps</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">filterTxt</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="c1"># Write targets.</span>
    <span class="k">for</span> <span class="n">trg</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trg</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="c1"># Action function for the generator.</span>
<span class="k">def</span> <span class="nf">generatorAction</span><span class="p">(</span><span class="n">bldr</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">cfgPath</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">fileDeps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cfgValue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfgPath</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfgValue</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;gen/gen{}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">bldr</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;Generated file {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Important! All the generated files have to be appended for Task.generatedFiles.</span>
        <span class="c1"># In real case, when the generator is an external binary, you can use</span>
        <span class="c1"># Task.addGeneratedFiles(fs, dpath) for scanning up the generators output directory.</span>
        <span class="n">task</span><span class="o">.</span><span class="n">generatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>    <span class="c1"># success</span>


<span class="c1"># This example runs on a virtual (mock) filesystem.</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">MockFS</span><span class="p">()</span>
<span class="c1"># Let&#39;s create some static files for input.</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;src/a.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;aFile</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;src/b.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;bFile</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># Creating a generator configuration file.</span>
<span class="c1"># Here content 3 means the number of files, the generator creates.</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cfg/cfg.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="n">mkDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># Create a Builder.</span>
<span class="n">bldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="c1"># Create the generator task.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;generator&#39;</span><span class="p">,</span>
    <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cfg/cfg.txt&#39;</span><span class="p">],</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>    <span class="c1"># It is a common up-to-date function which is good for most purposes.</span>
    <span class="n">action</span><span class="o">=</span><span class="n">generatorAction</span><span class="p">)</span>
<span class="c1"># Create a task for concatenating files.</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>     <span class="c1"># It is just a short alias name for the task.</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out/concat.txt&#39;</span><span class="p">],</span>
    <span class="n">fileDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src/a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;src/b.txt&#39;</span><span class="p">],</span>
    <span class="n">taskDeps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">],</span>     <span class="c1"># Note: this task depends on the generator task too.</span>
    <span class="n">upToDate</span><span class="o">=</span><span class="n">targetUpToDate</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="n">concat</span><span class="p">)</span>
<span class="c1"># Build the target. It is the same as bldr.buildOne(&#39;out/concat.txt&#39;)</span>
<span class="n">bldr</span><span class="o">.</span><span class="n">buildOne</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="c1"># Print the target.</span>
<span class="k">print</span> <span class="s2">&quot;Content of target:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;out/concat.txt&#39;</span><span class="p">))</span>
<span class="c1"># Print the PlantUML representation of the after-build dependency graph.</span>
<span class="k">print</span> <span class="n">bldr</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">genPlantUML</span><span class="p">()</span>
</pre></div>


<p>Here is the visual representation of the dependency graph. Note that the generated files are not directly depending on
task <i>all</i>. Task <i>all</i> fetches the generated files from the <i>generator</i> task. In other words, the generator
doesn't inject the generated files between itself and its parent tasks into the dependency graph. This makes possible simple
internal implementation.</p>
<img src="gen0.png"/>
<p>Note that the dependency graph doesn't show that which generated files are fetched by task <i>all</i>. It may be worked around by
careful generator task layering. E.g. there could be an other generator task between task <i>all</i> and task <i>generator</i>. The
intermediate generator task would just mirror those generated files which are fetched by task <i>all</i>. This concept is not yet
tested and documented.</p>
<p>If a generator generates a lot of unused temporary files (garbage) that would slow down the up-to-date checks and would result
ugly/bloated PlantUML generation. In the future it would worth to register only the useful files as <i>generatedFiles</i> and register
the remaining files as <i>garbage</i>. <i>garbage</i> would be considered only at <i>clean</i> execution.</p>

<h3>More complex case</h3>
The generated code needs some compilation before it is used by the parent task.

</body>
</html>
